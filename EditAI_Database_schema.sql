-- Users Table\nCREATE TABLE IF NOT EXISTS users (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  email VARCHAR(255) UNIQUE NOT NULL,\n  password_hash VARCHAR(255) NOT NULL,\n  name VARCHAR(255),\n  subscription_tier VARCHAR(50) DEFAULT 'free' CHECK (subscription_tier IN ('free', 'pro', 'team')),\n  stripe_customer_id VARCHAR(255),\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Edit Plans Table\nCREATE TABLE IF NOT EXISTS edit_plans (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  title VARCHAR(255),\n  video_title VARCHAR(255),\n  command TEXT,\n  plan_json JSONB NOT NULL,\n  status VARCHAR(50) DEFAULT 'completed' CHECK (status IN ('pending', 'completed', 'failed')),\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Subscriptions Table\nCREATE TABLE IF NOT EXISTS subscriptions (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  stripe_subscription_id VARCHAR(255) UNIQUE,\n  stripe_customer_id VARCHAR(255),\n  tier VARCHAR(50) CHECK (tier IN ('pro', 'team')),\n  status VARCHAR(50) DEFAULT 'active' CHECK (status IN ('active', 'past_due', 'canceled')),\n  current_period_start TIMESTAMP,\n  current_period_end TIMESTAMP,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Usage Logs Table\nCREATE TABLE IF NOT EXISTS usage_logs (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n  action VARCHAR(100),\n  metadata JSONB,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Indexes\nCREATE INDEX IF NOT EXISTS idx_edit_plans_user_id ON edit_plans(user_id);\nCREATE INDEX IF NOT EXISTS idx_edit_plans_created_at ON edit_plans(created_at);\nCREATE INDEX IF NOT EXISTS idx_subscriptions_user_id ON subscriptions(user_id);\nCREATE INDEX IF NOT EXISTS idx_usage_logs_user_id ON usage_logs(user_id);\nCREATE INDEX IF NOT EXISTS idx_usage_logs_created_at ON usage_logs(created_at);\n\n-- Triggers for updated_at\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = CURRENT_TIMESTAMP;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_edit_plans_updated_at BEFORE UPDATE ON edit_plans\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_subscriptions_updated_at BEFORE UPDATE ON subscriptions\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n
